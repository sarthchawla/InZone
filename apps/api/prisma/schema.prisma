// Prisma schema for InZone

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id
  name          String
  email         String    @unique
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime
  // Added by admin plugin:
  role            String?
  banned          Boolean?
  banReason       String?
  banExpires      DateTime?
  // Added by username plugin:
  username        String?   @unique
  displayUsername String?

  sessions           Session[]
  accounts           Account[]
  boards             Board[]
  invitesCreated     Invite[]           @relation("InviteCreator")
  securityQuestions  SecurityQuestion[]

  @@map("user")
}

model Session {
  id              String   @id
  token           String   @unique
  userId          String
  expiresAt       DateTime
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime
  updatedAt       DateTime
  // Added by admin plugin:
  impersonatedBy  String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime
  updatedAt  DateTime

  @@map("verification")
}

model RateLimit {
  id          String @id
  key         String
  count       Int
  lastRequest BigInt

  @@map("rateLimit")
}

model Board {
  id          String    @id @default(cuid())
  name        String
  description String?
  position    Int       @default(0)
  templateId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  isDeleted   Boolean   @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  columns Column[]

  @@index([isDeleted])
  @@index([userId])
  @@map("boards")
}

model Column {
  id          String    @id @default(cuid())
  name        String
  description String?
  position    Int       @default(0)
  wipLimit    Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  isDeleted   Boolean   @default(false)

  boardId String
  board   Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)

  todos Todo[]

  @@index([isDeleted])
  @@index([boardId, position])
  @@map("columns")
}

model Todo {
  id          String    @id @default(cuid())
  title       String
  description String?
  priority    Priority  @default(MEDIUM)
  dueDate     DateTime?
  position    Int       @default(0)
  archived    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  isDeleted   Boolean   @default(false)

  // Future: source tracking for integrations
  sourceType SourceType?
  sourceId   String?
  sourceUrl  String?
  sourceMeta Json?

  columnId String
  column   Column @relation(fields: [columnId], references: [id], onDelete: Cascade)

  labels Label[]

  @@unique([sourceType, sourceId])
  @@index([isDeleted])
  @@map("todos")
}

model Label {
  id    String @id @default(cuid())
  name  String
  color String

  todos Todo[]

  @@map("labels")
}

model BoardTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  columns     Json
  isBuiltIn   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("board_templates")
}

model Invite {
  id          String    @id @default(cuid())
  email       String
  token       String    @unique
  role        String    @default("user")
  status      String    @default("pending")
  usedAt      DateTime?
  expiresAt   DateTime
  createdBy   String
  createdAt   DateTime  @default(now())

  creator     User      @relation("InviteCreator", fields: [createdBy], references: [id])

  @@index([email])
  @@index([status])
  @@map("invite")
}

model AccessRequest {
  id            String    @id @default(cuid())
  email         String
  name          String
  reason        String?
  passwordHash  String
  status        String    @default("pending")
  role          String    @default("user")
  reviewedBy    String?
  reviewedAt    DateTime?
  createdAt     DateTime  @default(now())

  @@index([email])
  @@index([status])
  @@map("access_request")
}

model SecurityQuestion {
  id         String   @id @default(cuid())
  userId     String
  question   String
  answer     String
  order      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, order])
  @@map("security_question")
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SourceType {
  JIRA
  SLACK
  TEAMS
  OUTLOOK
  MANUAL
}
